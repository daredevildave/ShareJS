(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x=function(a,b){return function(){return a.apply(b,arguments)}},y=Array.prototype.slice,z=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]===a)return b;return-1};window.sharejs=k={version:"0.5.0"},q=function(a){return setTimeout(a,0)},d=function(){function a(){}return a.prototype.on=function(a,b){var c;return this._events||(this._events={}),(c=this._events)[a]||(c[a]=[]),this._events[a].push(b),this},a.prototype.removeListener=function(a,b){var c,d,e;this._events||(this._events={}),d=(e=this._events)[a]||(e[a]=[]),c=0;while(c<d.length)d[c]===b&&(d[c]=void 0),c++;return q(x(function(){var b;return this._events[a]=function(){var c,d,e=this._events[a],f=[];for(c=0,d=e.length;c<d;c++)b=e[c],b&&f.push(b);return f}.call(this)},this)),this},a.prototype.emit=function(){var a,b,c,d,e,f=arguments[0],g=2<=arguments.length?y.call(arguments,1):[];if((d=this._events)!=null?!d[f]:!void 0)return this;e=this._events[f];for(b=0,c=e.length;b<c;b++)a=e[b],a&&a.apply(this,g);return this},a}(),d.mixin=function(a){var b=a.prototype||a;return b.on=d.prototype.on,b.removeListener=d.prototype.removeListener,b.emit=d.prototype.emit,a},k._bt=g=function(a,b,c,d){var e,f=function(a,c,d,e){return b(d,a,c,"left"),b(e,c,a,"right")};return a.transformX=a.transformX=e=function(a,b){var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;c(a),c(b),k=[];for(p=0,t=b.length;p<t;p++){o=b[p],j=[],g=0;while(g<a.length){l=[],f(a[g],o,j,l),g++;if(l.length!==1){if(l.length===0){x=a.slice(g);for(q=0,u=x.length;q<u;q++)h=x[q],d(j,h);o=null;break}y=e(a.slice(g),l),i=y[0],n=y[1];for(r=0,v=i.length;r<v;r++)h=i[r],d(j,h);for(s=0,w=n.length;s<w;s++)m=n[s],d(k,m);o=null;break}o=l[0]}o!=null&&d(k,o),a=j}return[a,k]},a.transform=a.transform=function(a,c,d){var f,g,h,i,j;if(d!=="left"&&d!=="right")throw new Error("type must be 'left' or 'right'");return c.length===0?a:a.length===1&&c.length===1?b([],a[0],c[0],d):d==="left"?(i=e(a,c),f=i[0],h=i[1],f):(j=e(c,a),h=j[0],g=j[1],g)}},s={},s.name="text",s.create=function(){return""},r=function(a,b,c){return a.slice(0,b)+c+a.slice(b)},i=function(a){var b,c;if(typeof a.p!="number")throw new Error("component missing position field");c=typeof a.i,b=typeof a.d;if(!(c==="string"^b==="string"))throw new Error("component needs an i or d field");if(!(a.p>=0))throw new Error("position cannot be negative")},j=function(a){var b,c,d;for(c=0,d=a.length;c<d;c++)b=a[c],i(b);return!0},s.apply=function(a,b){var c,d,e,f;j(b);for(e=0,f=b.length;e<f;e++){c=b[e];if(c.i!=null)a=r(a,c.p,c.i);else{d=a.slice(c.p,c.p+c.d.length);if(c.d!==d)throw new Error("Delete component '"+c.d+"' does not match deleted text '"+d+"'");a=a.slice(0,c.p)+a.slice(c.p+c.d.length)}}return a},s._append=f=function(a,b){var c,d,e;if(b.i===""||b.d==="")return;return a.length===0?a.push(b):(c=a[a.length-1],c.i!=null&&b.i!=null&&c.p<=(d=b.p)&&d<=c.p+c.i.length?a[a.length-1]={i:r(c.i,b.p-c.p,b.i),p:c.p}:c.d!=null&&b.d!=null&&b.p<=(e=c.p)&&e<=b.p+b.d.length?a[a.length-1]={d:r(b.d,c.p-b.p,c.d),p:b.p}:a.push(b))},s.compose=function(a,b){var c,d,e,g;j(a),j(b),d=a.slice();for(e=0,g=b.length;e<g;e++)c=b[e],f(d,c);return d},s.compress=function(a){return s.compose([],a)},s.normalize=function(a){var b,c,d,e,g=[];if(a.i!=null||a.p!=null)a=[a];for(c=0,d=a.length;c<d;c++)b=a[c],(e=b.p)!=null?e:b.p=0,f(g,b);return g},u=function(a,b,c){return b.i!=null?b.p<a||b.p===a&&c?a+b.i.length:a:a<=b.p?a:a<=b.p+b.d.length?b.p:a-b.d.length},s.transformCursor=function(a,b,c){var d,e,f,g=c==="right";for(e=0,f=b.length;e<f;e++)d=b[e],a=u(a,d,g);return a},s._tc=t=function(a,b,c,d){var e,g,h,i,k,l;j([b]),j([c]);if(b.i!=null)f(a,{i:b.i,p:u(b.p,c,d==="right")});else if(c.i!=null)l=b.d,b.p<c.p&&(f(a,{d:l.slice(0,c.p-b.p),p:b.p}),l=l.slice(c.p-b.p)),l!==""&&f(a,{d:l,p:b.p+c.i.length});else if(b.p>=c.p+c.d.length)f(a,{d:b.d,p:b.p-c.d.length});else if(b.p+b.d.length<=c.p)f(a,b);else{i={d:"",p:b.p},b.p<c.p&&(i.d=b.d.slice(0,c.p-b.p)),b.p+b.d.length>c.p+c.d.length&&(i.d+=b.d.slice(c.p+c.d.length-b.p)),h=Math.max(b.p,c.p),g=Math.min(b.p+b.d.length,c.p+c.d.length),e=b.d.slice(h-b.p,g-b.p),k=c.d.slice(h-c.p,g-c.p);if(e!==k)throw new Error("Delete ops delete different text in the same region of the document");i.d!==""&&(i.p=u(i.p,c),f(a,i))}return a},n=function(a){return a.i!=null?{d:a.i,p:a.p}:{i:a.d,p:a.p}},s.invert=function(a){var b,c,d,e=a.slice().reverse(),f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(n(b));return f},k.types||(k.types={}),g(s,t,j,f),k.types.text=s,s.api={provides:{text:!0},getLength:function(){return this.snapshot.length},getText:function(){return this.snapshot},insert:function(a,b,c){var d=[{p:a,i:b}];return this.submitOp(d,c),d},del:function(a,b,c){var d=[{p:a,d:this.snapshot.slice(a,a+b)}];return this.submitOp(d,c),d},_register:function(){return this.on("remoteop",function(a){var b,c,d,e=[];for(c=0,d=a.length;c<d;c++)b=a[c],e.push(b.i!==void 0?this.emit("insert",b.p,b.i):this.emit("delete",b.p,b.d));return e})}},h=function(a,b){var c,d;if(b.id){if(typeof b.id!="string")throw new Error("invalid id "+b.id);if(!b.as&&!a.sessions[b.id])throw new Error("Referenced session ID missing");if(b.p&&(c=b.p)==="cursor")throw new Error("Cannot change property "+b.p);if(b.source&&b.source!==b.id)throw new Error("Not allowed to change another client's session data");if(b.as&&typeof b.as!="object")throw new Error("Session objects must be objects")}else{if(!(!b.p||(d=b.p)!=="sessions"&&d!=="ctime"&&d!=="mtime"))throw new Error("Cannot change property "+b.p);if(b.source)throw new Error("Only the server can change the root document metadata")}},o={name:"meta",create:function(a){var b=Date.now();return a||(a={}),a.sessions={},a.ctime=b,a.mtime=b,a},applyOp:function(a,b,c,d){var e,f,g,h,i;d==null&&(d="left");if((g=c.meta)!=null?g.ts:void 0)a.mtime=c.meta.ts,(h=a.ctime)!=null?h:a.ctime=a.mtime;if(b.transformCursor){i=a.sessions;for(e in i)f=i[e],f.cursor!=null&&(f.cursor=b.transformCursor(f.cursor,c.op,d))}return a},transform:function(a,b,c,d){return b.c!=null&&a.transformCursor&&a.transformCursor(b.c,c,d),b},applyMop:function(a,b){return h(a,b),b.n?(a.sessions=b.n.sessions,a.ctime=b.n.ctime,a.mtime=b.n.mtime):b.as?a.sessions[b.id]=b.as:b.rs?delete a.sessions[b.id]:b.c!=null?a.sessions[b.id].cursor=b.c:b.p&&(b.id?b.v===void 0?delete a.sessions[b.id][b.p]:a.sessions[b.id][b.p]=b.v:b.v===void 0?delete a[b.p]:a[b.p]=b.v),a}},k.meta=o,p=k.meta,k.extendDoc=function(a,b){return c.prototype[a]=b},c=function(){function a(a,b,c){this.connection=a,this.name=b,this.shout=x(this.shout,this),this.flush=x(this.flush,this),c||(c={}),this.version=c.v,this.snapshot=c.snaphot,c.type&&this._setType(c.type),this.metadata=null,this.state="closed",this.autoOpen=!1,this._create=c.create,this.inflightOp=null,this.inflightCallbacks=[],this.inflightSubmittedIds=[],this.pendingOp=null,this.pendingCallbacks=[],this.serverOps={}}return a.prototype._xf=function(a,b){var c,d;return this.type.transformX?this.type.transformX(a,b):(c=this.type.transform(a,b,"left"),d=this.type.transform(b,a,"right"),[c,d])},a.prototype._otApply=function(a,b){var c=this.snapshot;this.snapshot=this.type.apply(this.snapshot,a),this.emit("change",a,c);if(b)return this.emit("remoteop",a,c)},a.prototype._mopApply=function(a){this.metadata||(this.metadata=p.create()),p.applyMop(this.metadata,a),this.emit("metachange",this.metadata),a.n&&this.emit("metanew",a.n),a.as&&this.emit("metainsert",a.id,a.as);if(a.rs)return this.emit("metaremove",a.id,a.rs)},a.prototype._connectionStateChanged=function(a,b){switch(a){case"disconnected":this.state="closed",this.inflightOp&&this.inflightSubmittedIds.push(this.connection.id),this.emit("closed");break;case"ok":this.autoOpen&&this.open();break;case"stopped":typeof this._openCallback=="function"&&this._openCallback(b)}return this.emit(a,b)},a.prototype._setType=function(a){var b,c,d;typeof a=="string"&&(a=v[a]);if(!a||!a.compose)throw new Error("Support for types without compose() is not implemented");this.type=a;if(a.api){d=a.api;for(b in d)c=d[b],this[b]=c;return typeof this._register=="function"?this._register():void 0}return this.provides={}},a.prototype._onMessage=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;if(a.open===!0)return this.state="open",this._create=!1,this.created==null&&(this.created=!!a.create),a.type&&this._setType(a.type),a.create?(this.created=!0,this.snapshot=this.type.create()):(this.created!==!0&&(this.created=!1),a.snapshot!==void 0&&(this.snapshot=a.snapshot)),a.v!=null&&(this.version=a.v),this.inflightOp?(h={doc:this.name,op:this.inflightOp,v:this.version},this.inflightSubmittedIds.length&&(h.dupIfSource=this.inflightSubmittedIds),this.connection.send(h)):this.flush(),this.emit("open"),typeof this._openCallback=="function"?this._openCallback(null):void 0;if(a.open===!1)return a.error&&(typeof console!="undefined"&&console!==null&&console.error("Could not open document: "+a.error),this.emit("error",a.error),typeof this._openCallback=="function"&&this._openCallback(a.error)),this.state="closed",this.emit("closed"),typeof this._closeCallback=="function"&&this._closeCallback(),this._closeCallback=null;if(a.op!==null||d!=="Op already submitted"){if(a.op===void 0&&a.mop===void 0&&a.v!==void 0||a.op&&(o=a.meta.source,z.call(this.inflightSubmittedIds,o)>=0)){e=this.inflightOp,this.inflightOp=null,this.inflightSubmittedIds.length=0,d=a.error;if(d){this.type.invert?(i=this.type.invert(e),this.pendingOp&&(p=this._xf(this.pendingOp,i),this.pendingOp=p[0],i=p[1]),this._otApply(i,!0)):this.emit("error","Op apply failed ("+d+") and the op could not be reverted"),q=this.inflightCallbacks;for(k=0,m=q.length;k<m;k++)b=q[k],b(d)}else{if(a.v!==this.version)throw new Error("Invalid version from server");this.serverOps[this.version]=e,this.version++,this.emit("acknowledge",e),r=this.inflightCallbacks;for(l=0,n=r.length;l<n;l++)b=r[l],b(null,e)}return this.flush()}if(a.op){if(a.v<this.version)return;return a.doc!==this.name?this.emit("error","Expected docName '"+this.name+"' but got "+a.doc):a.v!==this.version?this.emit("error","Expected version "+this.version+" but got "+a.v):(f=a.op,this.serverOps[this.version]=f,c=f,this.inflightOp!==null&&(s=this._xf(this.inflightOp,c),this.inflightOp=s[0],c=s[1]),this.pendingOp!==null&&(t=this._xf(this.pendingOp,c),this.pendingOp=t[0],c=t[1]),this.version++,this._otApply(c,!0))}if(a.mop)return this._mopApply(a.mop);if(!a.meta)return typeof console!="undefined"&&console!==null?console.warn("Unhandled document message:",a):void 0;u=a.meta,g=u.path,j=u.value;switch(g!=null?g[0]:void 0){case"shout":return this.emit("shout",j);default:return typeof console!="undefined"&&console!==null?console.warn("Unhandled meta op:",a):void 0}}},a.prototype.flush=function(){if(this.connection.state!=="ok"||this.inflightOp!==null||this.pendingOp===null)return;return this.inflightOp=this.pendingOp,this.inflightCallbacks=this.pendingCallbacks,this.pendingOp=null,this.pendingCallbacks=[],this.connection.send({doc:this.name,op:this.inflightOp,v:this.version})},a.prototype.submitOp=function(a,b){return this.type.normalize!=null&&(a=this.type.normalize(a)),this.snapshot=this.type.apply(this.snapshot,a),this.pendingOp!==null?this.pendingOp=this.type.compose(this.pendingOp,a):this.pendingOp=a,b&&this.pendingCallbacks.push(b),this.emit("change",a),setTimeout(this.flush,0)},a.prototype.shout=function(a){return this.connection.send({doc:this.name,meta:{path:["shout"],value:a}})},a.prototype.open=function(a){var b;this.autoOpen=!0;if(this.state!=="closed")return;return b={doc:this.name,open:!0},this.snapshot===void 0&&(b.snapshot=null),this.type&&(b.type=this.type.name),this.version!=null&&(b.v=this.version),this._create&&(b.create=!0),this.connection.send(b),this.state="opening",this._openCallback=x(function(b){return this._openCallback=null,typeof a=="function"?a(b):void 0},this)},a.prototype.close=function(a){return this.autoOpen=!1,this.state==="closed"?typeof a=="function"?a():void 0:(this.connection.send({doc:this.name,open:!1}),this.state="closed",this.emit("closing"),this._closeCallback=a)},a}(),d.mixin(c),k.Doc=c,v=k.types,a=window.BCSocket,e=window.SockJS,b=function(){function b(b,c){this.docs={},this.state="connecting",this.socket=typeof w!="undefined"&&w!==null?new e(b):new a(b,{reconnect:!0}),this.socket.send({auth:c?c:null}),this.socket.onmessage=x(function(a){var b;typeof w!="undefined"&&w!==null&&(a=JSON.parse(a.data));if(a.auth===null)return this.lastError=a.error,this.disconnect(),this.emit("connect failed",a.error);if(a.auth){this.id=a.auth,this.setState("ok");return}return b=a.doc,b!==void 0?this.lastReceivedDoc=b:a.doc=b=this.lastReceivedDoc,this.docs[b]?this.docs[b]._onMessage(a):typeof console!="undefined"&&console!==null?console.error("Unhandled message",a):void 0},this),this.connected=!1,this.socket.onclose=x(function(a){this.setState("disconnected",a);if(a==="Closed"||a==="Stopped by server")return this.setState("stopped",this.lastError||a)},this),this.socket.onerror=x(function(a){return this.emit("error",a)},this),this.socket.onopen=x(function(){return this.lastError=this.lastReceivedDoc=this.lastSentDoc=null,this.setState("handshaking")},this),this.socket.onconnecting=x(function(){return this.setState("connecting")},this)}return b.prototype.setState=function(a,b){var c,d,e,f;if(this.state===a)return;this.state=a,a==="disconnected"&&delete this.id,this.emit(a,b),e=this.docs,f=[];for(d in e)c=e[d],f.push(c._connectionStateChanged(a,b));return f},b.prototype.send=function(a){var b=a.doc;return b===this.lastSentDoc?delete a.doc:this.lastSentDoc=b,typeof w!="undefined"&&w!==null&&(a=JSON.stringify(a)),this.socket.send(a)},b.prototype.disconnect=function(){return this.socket.close()},b.prototype.makeDoc=function(a,b,d){var e;if(this.docs[a])throw new Error("Doc "+a+" already open");return e=new c(this,a,b),this.docs[a]=e,e.open(x(function(b){return b&&delete this.docs[a],d(b,b?void 0:e)},this))},b.prototype.openExisting=function(a,b){var c;return this.state==="stopped"?b("connection closed"):this.docs[a]?b(null,this.docs[a]):c=this.makeDoc(a,{},b)},b.prototype.open=function(a,b,c){var d;if(this.state==="stopped")return c("connection closed");if(this.state==="connecting"){this.on("handshaking",function(){return this.open(a,b,c)});return}typeof b=="function"&&(c=b,b="text"),c||(c=function(){}),typeof b=="string"&&(b=v[b]);if(!b)throw new Error("OT code for document type missing");if(a==null)throw new Error("Server-generated random doc names are not currently supported");if(this.docs[a]){d=this.docs[a],d.type===b?c(null,d):c("Type mismatch",d);return}return this.makeDoc(a,{create:!0,type:b.name},c)},b.prototype.setExtraHeaders=function(a){return this.socket.setExtraHeaders(a)},b}(),d.mixin(b),k.Connection=b,l=window.BCSocket!==void 0,m=window.SockJS!==void 0;if(!l&&!m)throw new Error("Must load socks or browserchannel before this library");m&&!l&&(w=!0),k.open=function(){var a={},c=function(c,d){var e,f,g,h;return g=window.location,h=w?"sockjs":"channel",c!=null?c:c=""+g.protocol+"//"+g.host+"/"+h,a[c]||(e=new b(c,d),f=function(){return delete a[c]},e.on("disconnected",f),e.on("connect failed",f),a[c]=e),a[c]},d=function(a){var b,c,d=0,e=a.docs;for(c in e)b=e[c],(b.state!=="closed"||b.autoOpen)&&d++;if(d===0)return a.disconnect()};return function(a,b,e,f){var g,h,i;return typeof e=="function"&&(f=e,e={}),i=e.origin,g=e.authentication,h=c(i,g),h.numDocs++,h.open(a,b,function(a,b){return a?(f(a),d(h)):(b.on("closed",function(){return d(h)}),f(null,b))}),h.on("connect failed"),h}}()}).call(this)